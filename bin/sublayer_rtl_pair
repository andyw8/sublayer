#!/usr/bin/env ruby

require "bundler/setup"
require "colorize"
require "sublayer"
require "open3"
require "pry"

include Sublayer::Agents

def make_tests_pass(test_command, file_path)
  loop do
    stdout, stderr, status = Open3.capture3(test_command)

    if status.exitstatus == 0
      puts "Tests passed!".green
      return
    else
      results = Sublayer::Agents::DangerouslyModifyFileContentsAgent.new(
        file_path: Dir.pwd + "/" + file_path,
        description: "Change the this code so that it passes all the tests in the test file: #{File.read(test_command.split(" ")[-1])}. The last run of the tests had these failures: #{stderr}. Only do just enough to make the current tests pass, we'll build more tests and implementation up over time. Take YAGNI in to account.",
        technologies: ["react", "react-testing-library", "javascript"]
      ).execute

      Sublayer::Agents::SaveFileContentsAgent.new(
        file_contents: results,
        file_path: Dir.pwd + "/" + file_path
      ).execute
    end
  end
end

make_tests_pass ARGV[0], ARGV[1]
